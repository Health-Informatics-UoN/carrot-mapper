# Generated by Django 5.2.1 on 2025-06-09 14:53

from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ("contenttypes", "0002_remove_content_type_name"),
        ("data", "__first__"),
        ("mapping", "0006_scanreporttable_trigger_reuse"),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.AlterField(
            model_name="dataset",
            name="hidden",
            field=models.BooleanField(db_index=True, default=False),
        ),
        migrations.AlterField(
            model_name="mappingstatus",
            name="value",
            field=models.CharField(db_index=True, max_length=64),
        ),
        migrations.AlterField(
            model_name="omoptable",
            name="table",
            field=models.CharField(db_index=True, max_length=64),
        ),
        migrations.AlterField(
            model_name="scanreportconcept",
            name="creation_type",
            field=models.CharField(
                choices=[("M", "Manual"), ("V", "Vocab"), ("R", "Reuse")],
                db_index=True,
                default="M",
                max_length=1,
            ),
        ),
        migrations.AlterField(
            model_name="scanreportfield",
            name="name",
            field=models.CharField(db_index=True, max_length=512),
        ),
        migrations.AlterField(
            model_name="scanreporttable",
            name="name",
            field=models.CharField(db_index=True, max_length=256),
        ),
        migrations.AlterField(
            model_name="scanreportvalue",
            name="value",
            field=models.CharField(db_index=True, max_length=128),
        ),
        migrations.AlterField(
            model_name="scanreportvalue",
            name="value_description",
            field=models.CharField(
                blank=True, db_index=True, max_length=512, null=True
            ),
        ),
        migrations.AddIndex(
            model_name="mappingrule",
            index=models.Index(
                fields=["scan_report", "concept"], name="idx_mappingrule_sr_concept"
            ),
        ),
        migrations.AddIndex(
            model_name="mappingrule",
            index=models.Index(
                fields=["omop_field", "source_field"],
                name="idx_maprule_omop_scr_fields",
            ),
        ),
        migrations.AddIndex(
            model_name="omopfield",
            index=models.Index(fields=["table", "field"], name="idx_omop_table_field"),
        ),
        migrations.AddIndex(
            model_name="scanreport",
            index=models.Index(
                fields=["parent_dataset", "hidden"], name="idx_sr_dataset_hidden"
            ),
        ),
        migrations.AddIndex(
            model_name="scanreport",
            index=models.Index(
                fields=["parent_dataset", "hidden", "mapping_status"],
                name="idx_sr_dataset_status",
            ),
        ),
        migrations.AddIndex(
            model_name="scanreportconcept",
            index=models.Index(
                fields=["object_id", "content_type"], name="idx_sr_concept_obj_content"
            ),
        ),
        migrations.AddIndex(
            model_name="scanreportconcept",
            index=models.Index(
                fields=["object_id", "content_type", "concept"],
                name="idx_src_obj_content_concept",
            ),
        ),
        migrations.AddIndex(
            model_name="scanreportconcept",
            index=models.Index(
                fields=["creation_type", "content_type"],
                name="idx_src_creation_content",
            ),
        ),
        migrations.AddIndex(
            model_name="scanreportvalue",
            index=models.Index(
                fields=["scan_report_field", "value"], name="idx_sr_value_field_value"
            ),
        ),
        migrations.RunSQL(
            sql="""
        -- OMOP concept indexes (different schema - can't be in Django models)
        CREATE INDEX IF NOT EXISTS idx_concept_code_vocabulary ON omop.concept(concept_code, vocabulary_id);
        CREATE INDEX IF NOT EXISTS idx_concept_standard_domain ON omop.concept(standard_concept, domain_id);
        CREATE INDEX IF NOT EXISTS idx_concept_code_vocabulary_standard ON omop.concept(concept_code, vocabulary_id, standard_concept, domain_id);
        
        -- Conditional index (Django doesn't support WHERE clauses)
        CREATE INDEX IF NOT EXISTS idx_concept_relationship_maps_to ON omop.concept_relationship(concept_id_1, relationship_id) WHERE relationship_id = 'Maps to';
        
        -- Django ContentType model
        CREATE INDEX IF NOT EXISTS idx_django_content_type_app_model ON django_content_type(app_label, model);
        """,
            reverse_sql="""
        DROP INDEX IF EXISTS omop.idx_concept_relationship_maps_to;
        DROP INDEX IF EXISTS omop.idx_concept_code_vocabulary_standard;
        DROP INDEX IF EXISTS omop.idx_concept_standard_domain;
        DROP INDEX IF EXISTS omop.idx_concept_code_vocabulary;
        DROP INDEX IF EXISTS idx_django_content_type_app_model;
        """,
        ),
    ]
